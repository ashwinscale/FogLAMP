#!/bin/bash
##############################################################################
#
# FogLAMP SOW Acceptance Criteria test
# Copyright (C) 2018 Dianomic Systems, Inc.
#
##############################################################################

##############################################################################
#
## This script is used to run SOW Acceptance Criteria tests related to
## 'Admin'
#
##############################################################################

# Global constants declaration
declare EXECUTION_ENV
declare SUITE_BASEDIR
declare TEST_BASEDIR
declare RESULT_DIR
declare TEST_NAME

declare FOGLAMP_SERVER
declare FOGLAMP_HTTPPort
declare FOGLAMP_SNAP_VERSION
declare FOGLAMP_SNAP_UPDATE_VERSION
declare FOGLAMP_NAME
declare FOGLAMP_SNAP
declare FOGLAMP_PORT
declare SENDING_PROCESS_DATA
declare SCHEDULE_ID_OMF_PLUGIN

declare PI_SERVER
declare PI_SERVER_PORT
declare OMF_PRODUCER_TOKEN
declare OMF_TYPE_ID

declare SNAPS_DIRECTORY

declare ASSET_CODE
declare RETRY_COUNT

declare FOGLAMP_ROOT
declare FOGLAMP_AVAHI_STRING
declare CMD_JQ
declare CMD_AVBROWSE
declare CMD_CURL

declare SUITE_NAME
declare TMP_DIRECTORY


# Reads configuration setting
source ${SUITE_BASEDIR}/suite.cfg


if [[ "${EXECUTION_ENV}" != "ucore" ]]; then

    echo ERROR : Test implemented only for Ubuntu core environment.
    exit 1
fi

#
## Temporary files, one will be overwritten every time the second one used only in append mode
#
export TMP_FILE_OVERWRITE="$RESULT_DIR/$TEST_NAME.4.temp"
export TMP_FILE_APPEND="$RESULT_DIR/$TEST_NAME.5.temp"

export TEST_ID="${TEST_NAME:0:4}"
export TEST_ASSET_CODE=${ASSET_CODE}_${TEST_ID}

#
## Main
#

###  #########################################################################################:


# Updates the expected file to avoid storing of hardcoded versions
echo "${FOGLAMP_NAME} ${FOGLAMP_SNAP_VERSION}"         >  ${SUITE_NAME}/e/${TEST_NAME}.expected
echo "${FOGLAMP_NAME} ${FOGLAMP_SNAP_UPDATE_VERSION}"  >> ${SUITE_NAME}/e/${TEST_NAME}.expected

# Lists the initial snap
version_initial=`snap list | grep ${FOGLAMP_NAME} | awk '{ print $1 " " $2}'                                            2>> ${RESULT_DIR}/$TEST_NAME.2.temp`
echo ${version_initial}

# Starts FogLAMP
$TEST_BASEDIR/bash/starts_foglamp.bash                                                                                  >>  ${RESULT_DIR}/$TEST_NAME.1.temp 2>> ${RESULT_DIR}/$TEST_NAME.2.temp

# Starts the update process to create the initial configuration
${CMD_CURL}  -X PUT http://localhost:8081/foglamp/update                                                                >>  ${RESULT_DIR}/$TEST_NAME.1.temp 2>> ${RESULT_DIR}/$TEST_NAME.2.temp

# Waits until the update process has created the default configurations
${TEST_BASEDIR}/bash/wait_creation_cfg.bash "SNAP_UPD/repository"                                                       >>  ${RESULT_DIR}/$TEST_NAME.1.temp 2>> ${RESULT_DIR}/$TEST_NAME.2.temp

# Retrieves the configuration - for monitoring reason
${CMD_CURL}  -X GET http://localhost:8081/foglamp/category/SNAP_UPD/repository                                          >> ${RESULT_DIR}/$TEST_NAME.1.temp 2>> ${RESULT_DIR}/$TEST_NAME.2.temp

# Configures the update process to retrieves the snaps from the local file system
sudo classic << EOF                                                                                                     >> ${RESULT_DIR}/$TEST_NAME.1.temp 2>> ${RESULT_DIR}/$TEST_NAME.2.temp
    #!/bin/bash
    curl -X PUT -d '{"value": "file:///${TMP_DIRECTORY}"}' http://${FOGLAMP_SERVER}:${FOGLAMP_HTTPPort}/foglamp/category/SNAP_UPD/repository
    logout
EOF

# Retrieves the updated configuration - for monitoring reason
${CMD_CURL}  -X GET http://localhost:8081/foglamp/category/SNAP_UPD/repository                                          >> ${RESULT_DIR}/$TEST_NAME.1.temp 2>> ${RESULT_DIR}/$TEST_NAME.2.temp

# Executes the update retrieving the snap from the local file system
${CMD_CURL}  -X PUT http://localhost:8081/foglamp/update                                                                >>  ${RESULT_DIR}/$TEST_NAME.1.temp 2>> ${RESULT_DIR}/$TEST_NAME.2.temp

# Waits until either the version is updated or the timeout is reached
count=0
while [ true ]
do
    # Checks the FogLAMP snap version
    version_updated=`snap list | grep ${FOGLAMP_NAME} |  awk '{ print $1 " " $2}'                                       2>> ${RESULT_DIR}/$TEST_NAME.2.temp`

    if [[ ${version_updated} == "${FOGLAMP_NAME} ${FOGLAMP_SNAP_UPDATE_VERSION}" ]]; then

        echo FogLAMP Updated - current version :${version_updated}: - N. of retries :${count}:                          >> ${RESULT_DIR}/$TEST_NAME.1.temp 2>> ${RESULT_DIR}/$TEST_NAME.2.temp
        break
    else
        if [[ $count -le ${RETRY_COUNT} ]]
        then
            echo FogLAMP still not updated, waiting... - N. of retries :${count}:                                       >> ${RESULT_DIR}/$TEST_NAME.1.temp 2>> ${RESULT_DIR}/$TEST_NAME.2.temp
            sleep 1
            count=$((count+1))
        else
            echo FogLAMP not updated, timeout reached - N. of retries :${count}:                                        >> $RESULT_DIR/$TEST_NAME.1.temp 2>&1
            exit 1
        fi
    fi
done

# Lists final FogLAMP snap version
version_updated=`snap list | grep ${FOGLAMP_NAME} |  awk '{ print $1 " " $2}'   2>> ${RESULT_DIR}/$TEST_NAME.2.temp`
echo ${version_updated}
